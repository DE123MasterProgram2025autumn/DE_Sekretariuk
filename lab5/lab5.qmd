---
title: "–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞ —Ä–æ–±–æ—Ç–∞ ‚Ññ5: –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è –≤ R"
subtitle: "–Ü–Ω–∂–µ–Ω–µ—Ä—ñ—è –¥–∞–Ω–∏—Ö | –ö—Ä–ù–£ —ñ–º. –ú. –û—Å—Ç—Ä–æ–≥—Ä–∞–¥—Å—å–∫–æ–≥–æ"
author: "[–°–µ–∫—Ä–µ—Ç–∞—Ä—é–∫ –í–∞–ª–µ—Ä—ñ–π](https://github.com/SquireUA)"
date: last-modified
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: left
    sidebar: left
    collapse-level: 2
    code-fold: true
    code-overflow: wrap
    page-layout: full
editor: visual
execute:
  echo: true
  warning: false
  message: false
---

## –ú–µ—Ç–∞ —Ä–æ–±–æ—Ç–∏

–û—Å–≤–æ—ó—Ç–∏ —Å—É—á–∞—Å–Ω—ñ –ø—ñ–¥—Ö–æ–¥–∏ –¥–æ *—Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è* –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞–∫–µ—Ç–∞ `purrr` —Ç–∞ –Ω–∞–≤—á–∏—Ç–∏—Å—è *–º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è* —á–µ—Ä–µ–∑ *–±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω—ñ—Å—Ç—å* (`foreach`, `furrr`, `future`). –ù–∞–≤—á–∏—Ç–∏—Å—è –±—É–¥—É–≤–∞—Ç–∏ *–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ, —á–∏—Ç–∞–±–µ–ª—å–Ω—ñ —Ç–∞ –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ –∫–æ–Ω–≤–µ—î—Ä–∏ –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö*, —è–∫—ñ –º–æ–∂—É—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ –≤–µ–ª–∏–∫–∏–º–∏ –æ–±—Å—è–≥–∞–º–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –∞–±–æ –¥–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª–∏–º–∏ –æ–ø–µ—Ä–∞—Ü—ñ—è–º–∏.

------------------------------------------------------------------------

## –í–∞—Ä—ñ–∞–Ω—Ç 1

### –¢–µ–º–∞: –ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∏—Ö –¥–∞–Ω–∏—Ö

–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ **7 —Ñ–∞–π–ª—ñ–≤** (`transaction_1.csv` ‚Äì `transaction_7.csv`), –∫–æ–∂–µ–Ω –∑ —è–∫–∏—Ö –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω—ñ –ø—Ä–æ –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é (—è–∫ —É –ø—Ä–∏–∫–ª–∞–¥—ñ). –û–¥–Ω–∞–∫ —É —Ä–µ–∞–ª—å–Ω–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—ó —Ç–∞–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤ –º–æ–∂–µ –±—É—Ç–∏ **—Ç–∏—Å—è—á—ñ**, —ñ –æ–±—Ä–æ–±–∫–∞ —ó—Ö –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ –∑–∞–π–º–µ –Ω–µ–ø—Ä–∏–π–Ω—è—Ç–Ω–æ –±–∞–≥–∞—Ç–æ —á–∞—Å—É.

–í–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è ‚Äî –ø–æ–±—É–¥—É–≤–∞—Ç–∏ **–º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–∏–π, –Ω–∞–¥—ñ–π–Ω–∏–π —Ç–∞ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π ETL-–∫–æ–Ω–≤–µ—î—Ä**, —è–∫–∏–π:

1.  –ë–µ–∑–ø–µ—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –≤—Å—ñ —Ñ–∞–π–ª–∏ (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –¥–µ—è–∫—ñ –ø–æ—à–∫–æ–¥–∂–µ–Ω—ñ)
2.  –ê–≥—Ä–µ–≥—É—î –¥–∞–Ω—ñ
3.  –í–∏–∫–æ–Ω—É—î –∞–Ω–∞–ª—ñ–∑
4.  –ó–±–µ—Ä—ñ–≥–∞—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ ‚Äî **–≤—Å–µ —Ü–µ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–∏—Ö –æ–±—á–∏—Å–ª–µ–Ω—å**.

------------------------------------------------------------------------

### üìå –ó–∞–≤–¥–∞–Ω–Ω—è

#### **–ï—Ç–∞–ø 1: –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ç–∞ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è (purrr)**

-   –°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `safe_read_transaction(path)`, —è–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `tryCatch()` –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ —á–∏—Ç–∞–Ω–Ω—è CSV.
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `list.files()` + `map()` –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö —Ñ–∞–π–ª—ñ–≤.
-   –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä—É–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∑ **–∑–∞–≥–∞–ª—å–Ω–æ—é —Å—É–º–æ—é (`sale_sum`) ‚â• 1000** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `keep()`.

```{r}
library(purrr)
library(dplyr)
library(readr)
#install.packages("furrr")
library(furrr)
library(future)


data_dir <- "data/transactions/"

safe_read_transaction <- function(path) {
  tryCatch(
    {
      df <- read_csv(path, show_col_types = FALSE, progress = FALSE)
      df <- df %>% rename_with(~ tolower(.x))
      required <- c("product_id","name","price","date","manager","clients","count","sale_sum","transaction_id")
      missing <- setdiff(required, names(df))
      if (length(missing) > 0) {
        stop(glue::glue("Missing columns: {paste(missing, collapse = ', ')} in {path}"))
      }
      df <- df %>%
        mutate(
          price = as.numeric(price),
          sale_sum = as.numeric(sale_sum),
          count = as.integer(count),
          date = as.character(date)
        )
      attr(df, "source_file") <- basename(path)
      return(df)
    },
    error = function(e) {
      warning(sprintf("Error reading %s: %s", basename(path), conditionMessage(e)))
      return(NULL)
    }
  )
}

files <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)

raw_list <- files %>% map(safe_read_transaction)

raw_list <- compact(raw_list)


high_value_list <- raw_list %>%
  keep(~ any(!is.na(.x$sale_sum) & .x$sale_sum >= 1000)) %>%
  map(~ dplyr::filter(.x, sale_sum >= 1000))

high_value_list
```

#### **–ï—Ç–∞–ø 2: –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü—ñ—è (reduce)**

-   –û–±‚Äô—î–¥–Ω–∞–π—Ç–µ –≤—Å—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –≤ —î–¥–∏–Ω—É —Ç–∞–±–ª–∏—Ü—é –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `reduce(bind_rows)`.
-   –î–æ–¥–∞–π—Ç–µ —Å—Ç–æ–≤–ø–µ—Ü—å `file_id` –Ω–∞ –æ—Å–Ω–æ–≤—ñ —ñ–º–µ–Ω—ñ —Ñ–∞–π–ª—É.

```{r}

add_file_id <- function(df, file_path) {
  if (is.null(df)) return(tibble())
  fid <- tools::file_path_sans_ext(basename(file_path))
  df %>% mutate(file_id = fid)
}

combined_all <- map2(raw_list, files, add_file_id) %>%
  reduce(bind_rows, .init = tibble())  

#combined_high <- map2(high_value_list, files, add_file_id) %>%
#  reduce(bind_rows, .init = tibble())

combined_all
```

#### **–ï—Ç–∞–ø 3: –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ (foreach + furrr)**

-   –ù–∞–ø–∏—à—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é `analyze_manager(df)`, —è–∫–∞ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ä–∞—Ö—É—î:
    -   –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π,
    -   –∑–∞–≥–∞–ª—å–Ω—É —Å—É–º—É –ø—Ä–æ–¥–∞–∂—ñ–≤,
    -   —Å–µ—Ä–µ–¥–Ω—ñ–π —á–µ–∫.
-   –í–∏–∫–æ–Ω–∞–π—Ç–µ —Ü–µ–π –∞–Ω–∞–ª—ñ–∑ **–¥–≤–æ–º–∞ —Å–ø–æ—Å–æ–±–∞–º–∏**:
    1.  –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `foreach(..., .combine = bind_rows) %dopar%`.
    2.  –ó–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `future_map_dfr()` –∑ `furrr`.

```{r}
#install.packages("foreach")
#install.packages("doParallel")
library(foreach)
library(doParallel)

analyze_manager <- function(df) {
  df %>%
    group_by(manager) %>%
    summarise(
      n_transactions = n(),
      total_sales = sum(sale_sum, na.rm = TRUE),
      avg_check = ifelse(n_transactions > 0, total_sales / n_transactions, NA_real_),
      .groups = "drop"
    ) %>%
    arrange(desc(total_sales))
}


n_cores <- max(1, parallel::detectCores() - 1)
cl <- makeCluster(n_cores)
registerDoParallel(cl)


foreach_res <- foreach(df = high_value_list, .combine = bind_rows, .packages = c("dplyr")) %dopar% {
  if (nrow(df) == 0) {
    tibble(manager = character(), n_transactions = integer(), total_sales = double(), avg_check = double())
  } else {
    analyze_manager(df)
  }
}

stopCluster(cl)
print("–ó—Ä–æ–±–ª–µ–Ω–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é foreach")
foreach_res

furrr_res <- future_map_dfr(high_value_list, ~ {
  if (nrow(.x) == 0) tibble(manager = character(), n_transactions = integer(), total_sales = double(), avg_check = double())
  else analyze_manager(.x)
}, .progress = TRUE)

print("–ó—Ä–æ–±–ª–µ–Ω–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é furrr")
furrr_res
```

#### **–ï—Ç–∞–ø 4: –ü—Ä–æ—Å—É–Ω—É—Ç–∞ –±–∞–≥–∞—Ç–æ–ø–æ—Ç–æ—á–Ω—ñ—Å—Ç—å (future)**

-   –°—Ç–≤–æ—Ä—ñ—Ç—å **–≤–∫–ª–∞–¥–µ–Ω—ñ —Ñ'—é—á–µ—Ä—Å–∏**:
    -   –ó–æ–≤–Ω—ñ—à–Ω—ñ–π —Ñ'—é—á–µ—Ä—Å ‚Äî –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ñ–∞–π–ª—É.
    -   –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Ñ'—é—á–µ—Ä—Å ‚Äî –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∞–ª—ñ–¥–∞—Ü—ñ—è —Ü—ñ–Ω–∏).
-   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `plan(list(multisession, multisession))`.
-   –î–æ–¥–∞–π—Ç–µ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫ —á–µ—Ä–µ–∑ `resolved()` —Ç–∞ `backtrace()`.

```{r}
library(stringr)

plan(list(multisession, multisession))

validate_row <- function(row) {
  tryCatch({
    if (is.na(row$price)) stop("price is NA")
    if (!is.numeric(row$price)) stop("price not numeric")
    if (row$price < 0) stop("price negative")
    row$.validation_ok <- TRUE
    row
  }, error = function(e) {
    row$.validation_ok <- FALSE
    row$.validation_error <- conditionMessage(e)
    row
  })
}

outer_futures <- map(files, ~ future({
  path <- .x
  df <- safe_read_transaction(path)
  if (is.null(df)) {
    list(path = path, result = tibble(), error = TRUE, msg = "Failed read")
  } else if (nrow(df) == 0) {
    list(path = path, result = tibble(), error = FALSE)
  } else {
    row_futures <- map(seq_len(nrow(df)), function(i) {
      row <- df[i, , drop = FALSE]
      future({
        validate_row(row)
      })
    })
    resolved_all <- purrr::map_lgl(row_futures, ~ resolved(.x))

    rows_validated <- purrr::map(row_futures, value) %>% bind_rows()

    list(path = path, result = rows_validated, error = FALSE)
  }
}, lazy = FALSE))  


resolved_outer <- map_lgl(outer_futures, ~ resolved(.x))


outer_results <- map(outer_futures, function(fut) {
  tryCatch({
    val <- value(fut)

    if (!is.null(val$result) && nrow(val$result) > 0 && ".validation_error" %in% names(val$result)) {
      n_err <- sum(!is.na(val$result$.validation_error))
      if (n_err > 0) {
        message(sprintf("File %s has %d validation errors.", basename(val$path), n_err))
      }
    }
    val
  }, error = function(e) {
    tb <- tryCatch(rlang::trace_back(), error = function(e) NULL)
    list(path = NA_character_, result = tibble(), error = TRUE, msg = conditionMessage(e), trace = tb)
  })
})


validated_by_file <- map(outer_results, ~ .x$result) %>% reduce(bind_rows, .init = tibble())

plan(sequential)

validated_by_file
```

#### **–ï—Ç–∞–ø 5: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤**

-   –ó–±–µ—Ä–µ–∂—ñ—Ç—å –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó —É —Ñ–∞–π–ª–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `walk2()` (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `high_value_1.csv`, `high_value_2.csv`, ...).

```{r}
out_dir <- file.path(data_dir, "high_value_output")
if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE)


file_indices <- seq_along(files)

output_names <- map_chr(files, ~ paste0("high_value_", tools::file_path_sans_ext(basename(.x)), ".csv"))


walk2(high_value_list, output_names, ~ {
  df <- .x
  out_path <- file.path(out_dir, .y)
  tryCatch({
    write_csv(df, out_path)
    message("Saved ", out_path)
  }, error = function(e) {
    warning("Failed to save ", out_path, ": ", conditionMessage(e))
  })
})
```
